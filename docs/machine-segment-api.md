# API Документация: Machine Segment Module

## Содержание

1. [Общая информация](#общая-информация)
2. [Важное примечание о параметрах запросов](#важное-примечание-о-параметрах-запросов)
3. [Эндпоинты](#эндпоинты)
   - [Получить все станки участка](#получить-все-станки-участка)
   - [Получить сменное задание для станка](#получить-сменное-задание-для-станка)
   - [Удалить задание](#удалить-задание)
   - [Переместить задание на другой станок](#переместить-задание-на-другой-станок)
   - [Обновить приоритет задания (не реализовано)](#обновить-приоритет-задания)

## Общая информация

Базовый URL: `/machine-segment`

Модуль предоставляет API для работы со станками и заданиями для них на производственных участках.

## Важное примечание о параметрах запросов

При отправке числовых параметров через URL (query-параметры), убедитесь, что значения передаются в корректном формате. В NestJS параметры запроса автоматически преобразуются из строк в числа при наличии соответствующих декораторов валидации.

**Пример корректного запроса:**
```
GET /machine-segment/machines?segmentId=2
```

**Если вы получаете ошибку валидации**: `segmentId must be a number conforming to the specified constraints`, это может означать, что параметр не может быть автоматически преобразован в число.

## эндпоинты

### Получить все станки участка

Получает список всех станков, принадлежащих определенному производственному участку, с дополнительной информацией.

#### Запрос

```
GET /machine-segment/machines
```

#### Параметры запроса

| Параметр   | Тип    | Обязательный | Описание                     | Пример |
|------------|--------|--------------|------------------------------|--------|
| segmentId  | number | Да           | ID производственного участка | 1      |

#### Пример запроса

```
GET /machine-segment/machines?segmentId=1
```

#### Ответ

Успешный ответ возвращает статус код 200 и массив станков:

```json
[
  {
    "id": 1,
    "name": "Станок №1",
    "status": "ACTIVE",
    "recommendedLoad": 100,
    "plannedQuantity": 150,
    "completedQuantity": 5
  },
  {
    "id": 2,
    "name": "Станок №2",
    "status": "INACTIVE",
    "recommendedLoad": 80,
    "plannedQuantity": 90,
    "completedQuantity": 5
  }
]
```

#### Коды ответов

| Статус код | Описание                      |
|------------|-------------------------------|
| 200        | Успешное выполнение запроса   |
| 400        | Ошибка валидации параметров   |
| 404        | Участок с указанным ID не найден |

---

### Получить сменное задание для станка

Получает список текущих заданий для конкретного станка.

#### Запрос

```
GET /machine-segment/machine-tasks
```

#### Параметры запроса

| Параметр  | Тип    | Обязательный | Описание     | Пример |
|-----------|--------|--------------|--------------|--------|
| machineId | number | Да           | ID станка    | 1      |

#### Пример запроса

```
GET /machine-segment/machine-tasks?machineId=1
```

#### Ответ

Успешный ответ возвращает статус код 200 и массив заданий:

```json
[
  {
    "operationId": 1,
    "priority": 1,
    "orderId": 123,
    "orderName": "Заказ №123",
    "detailArticle": "ABC-123",
    "detailName": "Фасад кухонный",
    "detailMaterial": "ДСП",
    "detailSize": "600x800",
    "palletName": "П-123",
    "quantity": 10,
    "status": "ON_MACHINE",
    "completionStatus": null
  },
  {
    "operationId": 2,
    "priority": 2,
    "orderId": 124,
    "orderName": "Заказ №124",
    "detailArticle": "ABC-124",
    "detailName": "Дверца шкафа",
    "detailMaterial": "МДФ",
    "detailSize": "400x600",
    "palletName": "П-124",
    "quantity": 15,
    "status": "IN_PROGRESS",
    "completionStatus": "PARTIALLY_COMPLETED"
  }
]
```

#### Коды ответов

| Статус код | Описание                      |
|------------|-------------------------------|
| 200        | Успешное выполнение запроса   |
| 400        | Ошибка валидации параметров   |
| 404        | Станок с указанным ID не найден |

---

### Удалить задание

Удаляет задание по указанному ID операции.

#### Запрос

```
DELETE /machine-segment/task/{operationId}
```

#### Параметры пути

| Параметр    | Тип    | Обязательный | Описание              | Пример |
|-------------|--------|--------------|------------------------|--------|
| operationId | number | Да           | ID операции/задания    | 1      |

#### Пример запроса

```
DELETE /machine-segment/task/1
```

#### Ответ

Успешный ответ возвращает статус код 200 и сообщение:

```json
{
  "message": "Задание с ID 1 успешно удалено"
}
```

#### Коды ответов

| Статус код | Описание                      |
|------------|-------------------------------|
| 200        | Успешное выполнение запроса   |
| 400        | Ошибка валидации параметров   |
| 404        | Задание с указанным ID не найдено |

---

### Переместить задание на другой станок

Перемещает задание на другой станок. При перемещении статус задания устанавливается в `ON_MACHINE`.
**Важно**: Нельзя перемещать задания со статусом `COMPLETED` (завершенные задания).

#### Запрос

```
POST /machine-segment/task/move
```

#### Параметры тела запроса

| Параметр       | Тип    | Обязательный | Описание                       | Пример |
|----------------|--------|--------------|--------------------------------|--------|
| operationId    | number | Да           | ID операции/задания            | 1      |
| targetMachineId| number | Да           | ID станка для перемещения      | 2      |

#### Пример запроса

```json
{
  "operationId": 1,
  "targetMachineId": 2
}
```

#### Ответ

Успешный ответ возвращает статус код 200 и сообщение:

```json
{
  "message": "Задание успешно перемещено на станок Станок №2"
}
```

#### Коды ответов

| Статус код | Описание                                  |
|------------|-------------------------------------------|
| 200        | Успешное выполнение запроса               |
| 400        | Невозможно переместить завершенное задание или ошибка валидации параметров |
| 404        | Задание или станок с указанным ID не найден |

---

### Обновить приоритет задания

Обновляет приоритет задания. 
**Примечание**: Этот эндпоинт упоминается в DTO, но не реа��изован в контроллере.

#### Ожидаемая структура запроса

```
POST /machine-segment/task/priority
```

#### Параметры тела запроса

| Параметр    | Тип    | Обязательный | Описание                           | Пример |
|-------------|--------|--------------|-----------------------------------|--------|
| operationId | number | Да           | ID операции/задания               | 1      |
| priority    | number | Да           | Новое значение приоритета         | 3      |

#### Пример запроса

```json
{
  "operationId": 1,
  "priority": 3
}
```

## Структуры данных

### MachineSegmentQueryDto

Структура запроса для получения станков участка:

```typescript
{
  segmentId: number;        // ID производственного участка
}
```

### MachineTaskQueryDto

Структура запроса для получения заданий станка:

```typescript
{
  machineId: number;        // ID станка
}
```

### MoveTaskDto

Структура запроса для перемещения задания на другой станок:

```typescript
{
  operationId: number;      // ID операции/задания
  targetMachineId: number;  // ID целевого станка
}
```

### DeleteTaskDto

Структура запроса для удаления задания:

```typescript
{
  operationId: number;      // ID операции/задания
}
```

### UpdateTaskPriorityDto

Структура запроса для обновления приоритета задания:

```typescript
{
  operationId: number;      // ID операции/задания
  priority: number;         // Новое значение приоритета
}
```

### MachineSegmentResponseDto

Структура, возвращаемая в ответ на запрос информации о станке:

```typescript
{
  id: number;               // ID станка
  name: string;             // Название станка
  status: string;           // Статус станка: "ACTIVE", "INACTIVE", "MAINTENANCE", "BROKEN"
  recommendedLoad: number;  // Рекомендуемая норма выработки (количество деталей)
  plannedQuantity: number;  // Запланированное количество деталей
  completedQuantity: number;// Выполненное количество деталей
}
```

### MachineTaskResponseDto

Структура, возвращаемая в ответ на запрос заданий станка:

```typescript
{
  operationId: number;           // ID операции
  priority: number | null;       // Приоритет задания (чем меньше, тем выше)
  orderId: number;               // ID заказа
  orderName: string;             // Название заказа
  detailArticle: string;         // Артикул детали
  detailName: string;            // Название детали
  detailMaterial: string;        // Материал детали
  detailSize: string;            // Размер детали
  palletName: string;            // Номер поддона
  quantity: number;              // Количеств�� деталей на поддоне
  status: string;                // Статус операции: "ON_MACHINE", "IN_PROGRESS", "COMPLETED", "BUFFERED"
  completionStatus?: string;     // Статус выполнения: "COMPLETED", "IN_PROGRESS", "PARTIALLY_COMPLETED"
}
```

## Справочники

### Статусы станка (из схемы Prisma)

| Значение    | Описание                                |
|-------------|-----------------------------------------|
| ACTIVE      | Станок активен и готов к работе         |
| INACTIVE    | Станок выключен или не используется     |
| MAINTENANCE | Станок на обслуживании или ремонте      |
| BROKEN      | Станок сломан                           |

### Статусы операции (из схемы Prisma)

| Значение    | Описание                                |
|-------------|-----------------------------------------|
| ON_MACHINE  | Поддон записан в задание для станка, но еще не обрабатывается |
| IN_PROGRESS | Операция выполняется                    |
| COMPLETED   | Операция завершена                      |
| BUFFERED    | Операция приостановлена, поддон помещен в буфер |