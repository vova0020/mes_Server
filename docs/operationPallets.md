# API документация модуля PalletOperations

## Обзор

Модуль Pallet Operations предоставляет API для управления операциями с поддонами в производственной среде. API включает методы для назначения поддонов на станки, перемещения в буфер, обновления статусов операций и получения информации об активных операциях.

## Базовый URL

```
/pallet-operations
```

## Роли пользователей

API поддерживает следующие роли пользователей с различными правами доступа:

- `MASTER` - Мастер, имеющий доступ к станкам и буферам в рамках своего участка
- `OPERATOR` - Оператор, имею��ий доступ только к определенным станкам

## Статусы операций

Операции могут иметь следующие статусы завершения:

- `COMPLETED` - Операция полностью завершена
- `IN_PROGRESS` - Операция в процессе выполнения
- `PARTIALLY_COMPLETED` - Операция частично завершена

## Endpoints

### Назначить поддон на станок

**POST** `/pallet-operations/assign-to-machine`

Назначает поддон на определенный станок для обработки.

#### Запрос

```json
{
  "palletId": 1,
  "machineId": 1,
  "processStepId": 1,
  "operatorId": 1, // опционально
  "userRole": "MASTER", // MASTER или OPERATOR
  "segmentId": 1 // опционально, обязателен для роли MASTER
}
```

#### Параметры запроса

| Параметр | Тип | Обязательный | Описание |
|----------|-----|-------------|----------|
| palletId | number | Да | ID поддона |
| machineId | number | Да | ID станка |
| processStepId | number | Да | ID этапа процесса |
| operatorId | number | Нет | ID оператора |
| userRole | string | Да | Роль пользователя (`MASTER` или `OPERATOR`) |
| segmentId | number | Нет (да для `MASTER`) | ID участка, к которому привязан пользователь |

#### Ответ

```json
{
  "message": "Поддон успешно назначен на станок",
  "operation": {
    "id": 1,
    "status": "IN_PROGRESS",
    "completionStatus": "IN_PROGRESS",
    "startedAt": "2023-07-20T10:00:00Z",
    "completedAt": null,
    "quantity": 10,
    "productionPallet": {
      "id": 1,
      "name": "Поддон-001"
    },
    "machine": {
      "id": 1,
      "name": "Станок-001",
      "status": "ACTIVE"
    },
    "processStep": {
      "id": 1,
      "name": "Распил"
    },
    "operator": {
      "id": 1,
      "username": "operator1",
      "details": {
        "fullName": "Иванов Иван"
      }
    }
  }
}
```

#### Особенности

- Если поддон находился в ячейке буфера, она автоматически освобождается
- Оператор может назначать только на станки, к которым у него есть доступ
- Мастер может назначать только на станки в своем участке
- При назначении поддона на станок, его предыдущая ячейка буфера освобождается и статус ячейки устанавливается на `AVAILABLE`

#### Коды ошибок

- `400 Bad Request` - Неверные параметры запроса
- `403 Forbidden` - Нет доступа к станку
- `404 Not Found` - Поддон, станок или этап процесса не найден
- `500 Internal Server Error` - Внутренняя ошибка сервера

---

### Переместить поддон в буфер

**POST** `/pallet-operations/move-to-buffer`

Перемещает поддон в указанную ячейку буфера без изменения статуса операции.

#### Запрос

```json
{
  "palletId": 1,
  "bufferCellId": 1,
  "userRole": "MASTER", // MASTER или OPERATOR
  "segmentId": 1 // опционально, обязателен для роли MASTER
}
```

#### Па��аметры запроса

| Параметр | Тип | Обязательный | Описание |
|----------|-----|-------------|----------|
| palletId | number | Да | ID поддона |
| bufferCellId | number | Да | ID ячейки буфера |
| userRole | string | Да | Роль пользователя (`MASTER` или `OPERATOR`) |
| segmentId | number | Нет (да для `MASTER`) | ID участка, к которому привязан пользователь |

#### Ответ

```json
{
  "message": "Поддон успешно перемещен в буфер",
  "pallet": {
    "id": 1,
    "name": "Поддон-001",
    "detailOperations": [
      {
        "id": 1,
        "processStep": {
          "id": 1,
          "name": "Распил"
        }
      }
    ]
  },
  "operation": {
    "id": 1,
    "status": "IN_PROGRESS",
    "processStep": {
      "id": 1,
      "name": "Распил"
    }
  }
}
```

#### Особенности

- Если поддон уже был в другой ячейке буфера, предыдущая ячейка автоматически освобождается
- Мастер может пер��мещать поддоны только в буферы, привязанные к его участку
- Статус новой ячейки буфера устанавливается на `OCCUPIED`
- Статус предыдущей ячейки буфера (если была) устанавливается на `AVAILABLE`

#### Коды ошибок

- `400 Bad Request` - Неверные параметры запроса
- `403 Forbidden` - Нет доступа к буферу
- `404 Not Found` - Поддон или ячейка буфера не найдены
- `500 Internal Server Error` - Внутренняя ошибка сервера

---

### Обновить статус операции

**POST** `/pallet-operations/update-status`

Обновляет статус операции (готово/в работе/выполнено частично).

#### Запрос

```json
{
  "operationId": 1,
  "status": "COMPLETED", // COMPLETED, IN_PROGRESS, PARTIALLY_COMPLETED
  "masterId": 1, // опционально
  "userRole": "MASTER", // MASTER или OPERATOR
  "segmentId": 1 // опционально, обязателен для роли MASTER
}
```

#### Параметры запроса

| Параметр | Тип | Обязатель��ый | Описание |
|----------|-----|-------------|----------|
| operationId | number | Да | ID операции |
| status | string | Да | Новый статус операции (`COMPLETED`, `IN_PROGRESS`, `PARTIALLY_COMPLETED`) |
| masterId | number | Нет | ID мастера, подтверждающего обновление |
| userRole | string | Да | Роль пользователя (`MASTER` или `OPERATOR`) |
| segmentId | number | Нет (да для `MASTER`) | ID участка, к которому привязан пользователь |

#### Ответ

```json
{
  "message": "Операция отмечена как завершенная",
  "operation": {
    "id": 1,
    "status": "COMPLETED",
    "completionStatus": "COMPLETED",
    "startedAt": "2023-07-20T10:00:00Z",
    "completedAt": "2023-07-20T12:00:00Z",
    "quantity": 10,
    "productionPallet": {
      "id": 1,
      "name": "Поддон-001"
    },
    "machine": {
      "id": 1,
      "name": "Станок-001",
      "status": "ACTIVE"
    },
    "processStep": {
      "id": 1,
      "name": "Распил"
    },
    "operator": {
      "id": 1,
      "username": "operator1",
      "details": {
        "fullName": "Иванов Иван"
      }
    },
    "master": {
      "id": 2,
      "username": "master1",
      "details": {
        "fullName": "Петров Петр"
      }
    }
  }
}
```

#### Особенности

- Оператор может обновлять только операции, назначенные ему
- Мастер может обновлять операции только на станках своего участка
- При статусах `COMPLETED` или `PARTIALLY_COMPLETED` операция считается завершенной и устанавливается время завершения

#### Коды ошибок

- `400 Bad Request` - Неверные параметры запроса
- `403 Forbidden` - Нет прав на обновление операции
- `404 Not Found` - Операция не найдена
- `500 Internal Server Error` - Внутренняя ошибка сервера

---

### Получить активные операции

**GET** `/pallet-operations/active`

Возвращает список активных операций с фильтрацие�� по роли и участку.

#### Параметры запроса

| Параметр | Тип | Обязательный | Описание |
|----------|-----|-------------|----------|
| userRole | string | Нет | Роль пользователя (`MASTER` или `OPERATOR`) |
| segmentId | number | Нет | ID участка (для фильтрации) |

#### Ответ

```json
[
  {
    "id": 1,
    "status": "IN_PROGRESS",
    "completionStatus": "IN_PROGRESS",
    "startedAt": "2023-07-20T10:00:00Z",
    "completedAt": null,
    "quantity": 10,
    "machine": {
      "id": 1,
      "name": "Станок-001",
      "status": "ACTIVE"
    },
    "processStep": {
      "id": 1,
      "name": "Распил"
    },
    "productionPallet": {
      "id": 1,
      "name": "Поддон-001",
      "detail": {
        "id": 1,
        "name": "Деталь-001"
      },
      "bufferCell": null
    },
    "operator": {
      "id": 1,
      "username": "operator1",
      "details": {
        "fullName": "Иванов Иван"
      }
    }
  }
]
```

#### Особенности

- Для роли `MASTER` с указанным `segmentId` выводятся только операции на станках этого участка
- Активными считаются операции со статусом `IN_PROGRESS`

---

### Получить поддоны в буфере

**GET** `/pallet-operations/buffered`

Возвращает список поддонов, находящихся в буферах.

#### Параметры запроса

| Параметр | Тип | Обязательный | Описание |
|----------|-----|-------------|----------|
| userRole | string | Нет | Роль пользователя (`MASTER` или `OPERATOR`) |
| segmentId | number | Нет | ID участка (для фильтрации) |

#### Ответ

```json
[
  {
    "id": 1,
    "name": "Поддон-001",
    "quantity": 10,
    "detail": {
      "id": 1,
      "name": "Деталь-001"
    },
    "bufferCell": {
      "id": 1,
      "code": "A1",
      "buffer": {
        "id": 1,
        "name": "Буфер-001"
      }
    },
    "detailOperations": [
      {
        "id": 1,
        "processStep": {
          "id": 1,
          "name": "Распил"
        },
        "machine": null
      }
    ]
  }
]
```

#### Особенности

- Для роли `MASTER` с указанным `segmentId` выводятся только поддоны в буферах, связанных с этим участком
- Возвращаются только поддоны, находящиеся в ячейках буфера (`bufferCellId != null`)

---

### Получить историю операций поддона

**GET** `/pallet-operations/history/:palletId`

Возвращает историю операций для указанного поддона.

#### Параметры пути

| Параметр | Тип | Описание |
|----------|-----|----------|
| palletId | number | ID поддона |

#### Параметры запроса

| Параметр | Тип | Обязательный | Описание |
|----------|-----|-------------|----------|
| userRole | string | Нет | Роль пользователя (`MASTER` или `OPERATOR`) |
| segmentId | number | Нет | ID участка (для фильтрации) |

#### Ответ

```json
{
  "palletId": 1,
  "palletName": "Под��он-001",
  "detailId": 1,
  "operations": [
    {
      "id": 1,
      "status": "COMPLETED",
      "completionStatus": "COMPLETED",
      "startedAt": "2023-07-20T10:00:00Z",
      "completedAt": "2023-07-20T12:00:00Z",
      "machine": {
        "id": 1,
        "name": "Станок-001"
      },
      "processStep": {
        "id": 1,
        "name": "Распил"
      },
      "operator": {
        "id": 1,
        "username": "operator1",
        "details": {
          "fullName": "Иванов Иван"
        }
      },
      "master": {
        "id": 2,
        "username": "master1",
        "details": {
          "fullName": "Петров Петр"
        }
      }
    }
  ]
}
```

#### Особенности

- Для роли `MASTER` с указанным `segmentId` выводятся только операции на станках этого участка
- Операции сортируются по времени начала (от новых к старым)

#### Коды ошибок

- `404 Not Found` - Поддон не найден
- `500 Internal Server Error` - Внутренняя ошибка сервера

## Логика работы с ролями

### Мастер (MASTER)

- Имеет доступ к станкам и буферам только своего участка
- При работе должен указывать свой `segmentId`
- Может обновлять статусы операций на станках своего участка

### Оператор (OPERATOR)

- Имеет доступ только к назначенным ему станкам
- Может обновлять только операции, назначенные ему

## Логика работы с буферами и станками

- При назначении поддона на станок, если поддон находился в буфере, ячейка буфера освобождается
- При перемещении поддона в буфер, если он уже был в другой ячейке, пр��дыдущая ячейка освобождается
- Ячейки буфера имеют статусы: `AVAILABLE` (доступна), `OCCUPIED` (занята)

## Обработка ошибок

API использует следующие коды HTTP-статусов для ошибок:

- `400 Bad Request` - Неверные параметры запроса
- `403 Forbidden` - Недостаточно прав для выполнения операции
- `404 Not Found` - Запрашиваемый ресурс не найден
- `500 Internal Server Error` - Внутренняя ошибка сервера