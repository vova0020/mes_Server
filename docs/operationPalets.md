
# Документация API для операций с поддонами

## Оглавление

1. [Введение](#введение)
2. [Базовый URL](#базовый-url)
3. [Объекты и структуры данных](#объекты-и-структуры-данных)
    - [Поддон (Pallet)](#поддон-pallet)
    - [Операция (DetailOperation)](#операция-detailoperation)
    - [Станок (Machine)](#станок-machine)
    - [Ячейка буфера (BufferCell)](#ячейка-буфера-buffercell)
4. [Эндпоинты API](#эндпоинты-api)
    - [Получение информации о поддонах](#получение-информации-о-поддонах)
    - [Назначение поддона на станок](#назначение-поддона-на-станок)
    - [Перемещение поддона в буфер](#перемещение-поддона-в-буфер)
    - [Обновление статуса операции](#обновление-статуса-операции)
    - [Получение активных операций](#получение-активных-операций)
    - [Получение поддонов в буфере](#получение-поддонов-в-буфере)
    - [Получение истории операций для поддона](#получение-истории-операций-для-поддона)
5. [Примеры использования](#примеры-использования)
    - [Пример жизненного цикла поддона](#пример-жизненного-цикла-поддона)
    - [Типичные сценарии использования](#типичные-сценарии-использования)
6. [Обработка ошибок](#обработка-ошибок)
    - [Коды ошибок](#коды-ошибок)
    - [Примеры ошибок](#примеры-ошибок)

## Введение

Данное API предназначено для управления производственными поддонами в системе:
- назначение поддонов на станки
- перемещение поддонов между станками и буфером
- обновление статусов операций с поддонами (готово, в работе, выполнено частично)
- получение информации о текущем состоянии поддонов

API построено по REST-принципам, использует JSON для обмена данными и стандартные HTTP-методы (GET, POST).

## Базовый URL

Базовый URL для всех запросов API:

```
https://api.example.com/
```

## Объекты и структуры данных

### Поддон (Pallet)

Поддон - основная единица в производственном процессе, содержащая детали одного типа.

**Основные поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | number | Уникальный идентификатор поддона |
| `name` | string | Название/номер поддона |
| `quantity` | number | Количество деталей на поддоне |
| `detailId` | number | ID типа детали на поддоне |
| `bufferCellId` | number \| null | ID ячейки буфера (если поддон в буфере) |

### Операция (DetailOperation)

Операция - запись о выполнении определённого этапа производственного процесса для конкретного поддона.

**Основные поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | number | Уникальный идентификатор операции |
| `productionPalletId` | number | ID поддона, к которому относится операция |
| `processStepId` | number | ID этапа производственного процесса |
| `machineId` | number \| null | ID станка, на котором выполняется операция |
| `operatorId` | number \| null | ID оператора, выполняющего операцию |
| `masterId` | number \| null | ID мастера, контролирующего операцию |
| `status` | string | Статус операции ("IN_PROGRESS", "COMPLETED") |
| `completionStatus` | string | Статус выполнения ("COMPLETED", "IN_PROGRESS", "PARTIALLY_COMPLETED") |
| `startedAt` | string (ISO date) | Дата и время начала операции |
| `completedAt` | string (ISO date) \| null | Дата и время завершения операции |
| `quantity` | number | Количество деталей, обрабатываемых в операции |

### Станок (Machine)

Станок - оборудование для обработки поддонов с деталями.

**Основные поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | number | Уникальный идентификатор станка |
| `name` | string | Название/номер станка |
| `status` | string | Статус станка ("ACTIVE", "INACTIVE", "MAINTENANCE") |
| `segmentId` | number \| null | ID производственного участка, к которому относится станок |

### Ячейка буфера (BufferCell)

Ячейка буфера - место для временного хранения поддона между операциями.

**Основные поля:**

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | number | Уникальный идентификатор ячейки |
| `code` | string | Код/номер ячейки (например, "A1", "B2") |
| `bufferId` | number | ID буфера, к которому относится ячейка |
| `status` | string | Статус ячейки ("AVAILABLE", "OCCUPIED", "RESERVED", "MAINTENANCE") |
| `capacity` | number | Вместимость ячейки (сколько поддонов может вместить) |

## Эндпоинты API

### Получение информации о поддонах

#### 1. Получение поддона по ID

**GET** `/pallets/:id`

Возвращает информацию о конкретном поддоне, включая данные о буфере и станке.

**Параметры пути:**
- `id` (number) - ID поддона

**Пример запроса:**
```
GET /pallets/42
```

**Пример успешного ответа (200 OK):**
```json
{
  "id": 42,
  "name": "П-2305-42",
  "quantity": 15,
  "detailId": 123,
  "bufferCell": {
    "id": 5,
    "code": "A3",
    "bufferId": 2,
    "bufferName": "Буфер участка присадки"
  },
  "machine": null
}
```

#### 2. Получение поддонов по ID детали

**GET** `/pallets/detail/:detailId`

Возвращает все поддоны для указанного типа детали.

**Параметры пути:**
- `detailId` (number) - ID детали

**Пример запроса:**
```
GET /pallets/detail/123
```

**Пример успешного ответа (200 OK):**
```json
{
  "pallets": [
    {
      "id": 42,
      "name": "П-2305-42",
      "quantity": 15,
      "detailId": 123,
      "bufferCell": {...},
      "machine": null
    },
    {
      "id": 43,
      "name": "П-2305-43",
      "quantity": 10,
      "detailId": 123,
      "bufferCell": null,
      "machine": {
        "id": 3,
        "name": "Присадка-В1",
        "status": "ACTIVE"
      }
    }
  ],
  "total": 2
}
```

### Назначение поддона на станок

**POST** `/pallet-operations/assign-to-machine`

Назначает поддон на указанный станок для выполнения операции. Можно назначать поддоны на разные станки сколько угодно раз.

**Тело запроса:**
```json
{
  "palletId": 42,
  "machineId": 3,
  "processStepId": 2,
  "operatorId": 10  // опционально
}
```

**Поля запроса:**
- `palletId` (number, обязательное) - ID поддона
- `machineId` (number, обязательное) - ID станка
- `processStepId` (number, обязательное) - ID этапа процесса
- `operatorId` (number, опциональное) - ID оператора, выполняющего операцию

**Пример успешного ответа (200 OK):**
```json
{
  "message": "Поддон успешно назначен на станок",
  "operation": {
    "id": 156,
    "status": "IN_PROGRESS",
    "completionStatus": "IN_PROGRESS",
    "startedAt": "2023-10-18T09:30:15.123Z",
    "quantity": 15,
    "productionPallet": {
      "id": 42,
      "name": "П-2305-42"
    },
    "machine": {
      "id": 3,
      "name": "Присадка-В1",
      "status": "ACTIVE"
    },
    "processStep": {
      "id": 2,
      "name": "Присадка"
    },
    "operator": {
      "id": 10,
      "username": "operator1",
      "details": {
        "fullName": "Иванов Иван Иванович"
      }
    }
  }
}
```

**Важные моменты:**
- Поддон должен существовать в системе
- Станок должен существовать и быть в статусе "ACTIVE"
- Если поддон уже активен на другом станке, то он будет перемещен на новый станок
- Если поддон находится в буфере, его физическое местоположение будет обновлено, но это не влияет на операции с ним

### Перемещение поддона в буфер

**POST** `/pallet-operations/move-to-buffer`

Перемещает поддон в указанную ячейку буфера без влияния на статус операции.

**Тело запроса:**
```json
{
  "palletId": 42,
  "bufferCellId": 5
}
```

**Поля запроса:**
- `palletId` (number, обязательное) - ID поддона
- `bufferCellId` (number, обязательное) - ID ячейки буфера

**Пример успешного ответа (200 OK):**
```json
{
  "message": "Поддон успешно перемещен в буфер",
  "pallet": {
    "id": 42,
    "name": "П-2305-42",
    "quantity": 15,
    "detailId": 123,
    "bufferCellId": 5,
    "detailOperations": [
      {
        "id": 156,
        "status": "IN_PROGRESS",
        "completionStatus": "IN_PROGRESS",
        "processStep": {
          "id": 2,
          "name": "Присадка"
        }
      }
    ]
  },
  "operation": {
    "id": 156,
    "status": "IN_PROGRESS",
    "completionStatus": "IN_PROGRESS"
  }
}
```

**Важные моменты:**
- Поддон должен существовать в системе
- Ячейка буфера должна быть в статусе "AVAILABLE"
- После перемещения статус операции НЕ меняется (остается "IN_PROGRESS")
- Ячейка буфера получает статус "OCCUPIED"

### Обновление статуса операции

**POST** `/pallet-operations/update-status`

Обновляет статус операции (готово, в работе, выполнено частично).

**Тело запроса:**
```json
{
  "operationId": 156,
  "status": "COMPLETED",  // варианты: "COMPLETED", "IN_PROGRESS", "PARTIALLY_COMPLETED"
  "masterId": 5  // опционально
}
```

**Поля запроса:**
- `operationId` (number, обязательное) - ID активной операции
- `status` (string, обязательное) - Новый статус операции (COMPLETED, IN_PROGRESS, PARTIALLY_COMPLETED)
- `masterId` (number, опциональное) - ID мастера, подтверждающего обновление статуса

**Пример успешного ответа (200 OK):**
```json
{
  "message": "Операция отмечена как завершенная",
  "operation": {
    "id": 156,
    "status": "COMPLETED",
    "completionStatus": "COMPLETED",
    "startedAt": "2023-10-18T09:30:15.123Z",
    "completedAt": "2023-10-18T10:45:22.456Z",
    "quantity": 15,
    "productionPallet": {
      "id": 42,
      "name": "П-2305-42"
    },
    "machine": {
      "id": 3,
      "name": "Присадка-В1",
      "status": "ACTIVE"
    },
    "processStep": {
      "id": 2,
      "name": "Присадка"
    },
    "operator": {
      "id": 10,
      "username": "operator1",
      "details": {
        "fullName": "Иванов Иван Иванович"
      }
    },
    "master": {
      "id": 5,
      "username": "master1",
      "details": {
        "fullName": "Петров Петр Петрович"
      }
    }
  }
}
```

**Важные моменты:**
- Операция должна быть в статусе "IN_PROGRESS"
- При установке статуса "COMPLETED" или "PARTIALLY_COMPLETED", операция полностью завершается и устанавливается время завершения (`completedAt`)
- При статусе "IN_PROGRESS" операция продолжается
- Статус "COMPLETED" или "PARTIALLY_COMPLETED" скрывает поддон из списка заданий станка

### Получение активных операций

**GET** `/pallet-operations/active`

Возвращает список всех активных операций (поддоны, которые сейчас обрабатываются на станках).

**Параметры запроса:** нет

**Пример запроса:**
```
GET /pallet-operations/active
```

**Пример успешного ответа (200 OK):**
```json
[
  {
    "id": 156,
    "status": "IN_PROGRESS",
    "completionStatus": "IN_PROGRESS",
    "startedAt": "2023-10-18T09:30:15.123Z",
    "quantity": 15,
    "productionPallet": {
      "id": 42,
      "name": "П-2305-42",
      "detail": {
        "id": 123,
        "name": "Деталь боковой стенки",
        "article": "DSW-123"
      },
      "bufferCell": {
        "id": 5,
        "code": "A3",
        "buffer": {
          "id": 2,
          "name": "Буфер участка присадки"
        }
      }
    },
    "machine": {
      "id": 3,
      "name": "Присадка-В1",
      "status": "ACTIVE"
    },
    "processStep": {
      "id": 2,
      "name": "Присадка"
    },
    "operator": {
      "id": 10,
      "username": "operator1",
      "details": {
        "fullName": "Иванов Иван Иванович"
      }
    }
  },
  // другие активные операции...
]
```

### Получение поддонов в буфере

**GET** `/pallet-operations/buffered`

Возвращает список всех поддонов, находящихся в буфере, вместе с их активными операциями.

**Параметры запроса:** нет

**Пример запроса:**
```
GET /pallet-operations/buffered
```

**Пример успешного ответа (200 OK):**
```json
[
  {
    "id": 41,
    "name": "П-2305-41",
    "quantity": 12,
    "detailId": 124,
    "bufferCellId": 8,
    "detail": {
      "id": 124,
      "name": "Деталь фасада",
      "article": "DF-124"
    },
    "bufferCell": {
      "id": 8,
      "code": "B2",
      "buffer": {
        "id": 3,
        "name": "Буфер участка кромки"
      }
    },
    "detailOperations": [
      {
        "id": 155,
        "status": "IN_PROGRESS",
        "completionStatus": "IN_PROGRESS",
        "processStep": {
          "id": 3,
          "name": "Кромление"
        },
        "machine": {
          "id": 5,
          "name": "Кромка-K1",
          "status": "ACTIVE"
        }
      }
    ]
  },
  // другие поддоны в буфере...
]
```

### Получение истории операций для поддона

**GET** `/pallet-operations/history/:palletId`

Возвращает историю всех операций, выполненных с указанным поддоном.

**Параметры пути:**
- `palletId` (number) - ID поддона

**Пример запроса:**
```
GET /pallet-operations/history/42
```

**Пример успешного ответа (200 OK):**
```json
{
  "palletId": 42,
  "palletName": "П-2305-42",
  "detailId": 123,
  "operations": [
    {
      "id": 156,
      "status": "IN_PROGRESS",
      "completionStatus": "IN_PROGRESS",
      "startedAt": "2023-10-18T09:30:15.123Z",
      "processStep": {
        "id": 2,
        "name": "Присадка"
      },
      "machine": {
        "id": 3,
        "name": "Присадка-В1",
        "status": "ACTIVE"
      },
      "operator": {
        "id": 10,
        "username": "operator1",
        "details": {
          "fullName": "Иванов Иван Иванович"
        }
      }
    },
    {
      "id": 152,
      "status": "COMPLETED",
      "completionStatus": "COMPLETED",
      "startedAt": "2023-10-17T11:15:30.456Z",
      "completedAt": "2023-10-17T12:30:45.789Z",
      "processStep": {
        "id": 1,
        "name": "Раскрой"
      },
      "machine": {
        "id": 1,
        "name": "Раскрой-R2",
        "status": "ACTIVE"
      },
      "operator": {
        "id": 12,
        "username": "operator3",
        "details": {
          "fullName": "Сидоров Сидор Сидорович"
        }
      },
      "master": {
        "id": 5,
        "username": "master1",
        "details": {
          "fullName": "Петров Петр Петрович"
        }
      }
    }
  ]
}
```

## Примеры использования

### Пример жизненного цикла поддона

1. **Создание поддона** (происходит в другом модуле системы)
2. **Назначение поддона на станок для первой операции:**
   ```
   POST /pallet-operations/assign-to-machine
   {
     "palletId": 42,
     "machineId": 1,
     "processStepId": 1,
     "operatorId": 12
   }
   ```
3. **Перемещение поддона в буфер (без изменения статуса операции):**
   ```
   POST /pallet-operations/move-to-buffer
   {
     "palletId": 42,
     "bufferCellId": 5
   }
   ```
4. **Возвращение поддона на станок (может быть другой станок):**
   ```
   POST /pallet-operations/assign-to-machine
   {
     "palletId": 42,
     "machineId": 2,
     "processStepId": 1,
     "operatorId": 12
   }
   ```
5. **Отметка операции как завершенной:**
   ```
   POST /pallet-operations/update-status
   {
     "operationId": 152,
     "status": "COMPLETED",
     "masterId": 5
   }
   ```
6. **Назначение поддона на станок для второй операции:**
   ```
   POST /pallet-operations/assign-to-machine
   {
     "palletId": 42,
     "machineId": 3,
     "processStepId": 2,
     "operatorId": 10
   }
   ```
7. **Отметка второй операции как частично завершенной:**
   ```
   POST /pallet-operations/update-status
   {
     "operationId": 156,
     "status": "PARTIALLY_COMPLETED",
     "masterId": 5
   }
   ```

### Типичные сценарии использования

1. **Отображение списка поддонов для детали:**
   - Получите список поддонов для детали
   - Определите их текущее местоположение (буфер или станок)
   - Отобразите информацию на панели управления

2. **Панель мониторинга станков:**
   - Получите список активных операций
   - Отфильтруйте операции со статусом "COMPLETED" или "PARTIALLY_COMPLETED" (они больше не требуют внимания)
   - Отобразите для каждого станка информацию о текущих активных операциях и поддонах

3. **Управление буфером:**
   - Получите список поддонов в буфере
   - Позвольте пользователю выбрать поддон для назначения на станок

4. **Управление статусами операций на станке:**
   - Отобразите кнопки для изменения статуса: "готово", "в работе", "выполнено частично"
   - При нажатии на соответствующую кнопку обновите статус операции

## Обработка ошибок

### Коды ошибок

| Код HTTP | Описание |
|----------|----------|
| 400 | Неверный запрос (например, неверные параметры) |
| 404 | Ресурс не найден (поддон, операция, станок и т.д.) |
| 500 | Внутренняя ошибка сервера |

### Примеры ошибок

**Пример ошибки 404 (поддон не найден):**
```json
{
  "statusCode": 404,
  "message": "Поддон с ID 9999 не найден",
  "error": "Not Found"
}
```

**Пример ошибки 400 (неверный запрос):**
```json
{
  "statusCode": 400,
  "message": "Станок Присадка-В1 (ID: 3) не готов к работе. Текущий статус: MAINTENANCE",
  "error": "Bad Request"
}
```

**Пример ошибки 400 (невозможно обновить статус):**
```json
{
  "statusCode": 400,
  "message": "Только активные операции можно обновлять. Текущий статус: COMPLETED",
  "error": "Bad Request"
}
```
