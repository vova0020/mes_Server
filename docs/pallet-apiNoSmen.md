
# API документация по работе с поддонами

## Общая информация

Модуль API для работы с поддонами на станках без сменного задания. Все запросы выполняются по базовому URL: `/pallets`.

## Эндпоинты

### 1. Начать обработку поддона на станке

**URL**: `/pallets/start-processing`  
**Метод**: POST  
**Описание**: Начинает процесс обработки поддона на указанном станке

#### Запрос:
```json
{
  "palletId": 1,     // ID поддона (обязательное поле)
  "machineId": 2,    // ID станка (обязательное поле)
  "operatorId": 3    // ID оператора, выполняющего обработку (опционально)
}
```

#### Ответ в случае успеха (HTTP 201):
```json
{
  "id": 42,          // ID созданной операции
  "productionPallet": {
    "id": 1,
    "name": "Поддон-001",
    "quantity": 50,
    // Информация о детали на поддоне
    "detail": {
      "id": 10,
      "article": "АРТ-123",
      "name": "Деталь XYZ",
      "material": "ДСП",
      "size": "1200x600"
      // и другие поля детали
    }
  },
  "processStep": {
    "id": 5,
    "name": "Распил",
    "sequence": 1
    // и другие поля этапа обработки
  },
  "machine": {
    "id": 2,
    "name": "Станок №2",
    "status": "ACTIVE"
    // и другие поля станка
  },
  "operator": {
    "id": 3,
    "username": "operator1",
    "details": {
      "fullName": "Иванов Иван",
      "position": "Оператор станка"
      // и другие детали оператора
    }
  },
  "status": "IN_PROGRESS",
  "quantity": 50,
  "startedAt": "2023-11-10T12:34:56Z"
}
```

#### Возможные ошибки (HTTP 400):
- `"Поддон не найден"` - указан несуществующий ID поддона
- `"Станок не найден"` - указан несуществующий ID станка
- `"У поддона не указан текущий этап обработки. Невозможно начать обработку"` - не задан текущий этап обработки для поддона
- `"Данный станок не может выполнять текущий этап обработки поддона"` - станок не подходит для текущего этапа обработки
- `"Поддон уже находится в обработке на другом станке"` - поддон уже обрабатывается

### 2. Завершить обработку поддона на станке

**URL**: `/pallets/complete-processing`  
**Метод**: POST  
**Описание**: Завершает процесс обработки поддона на станке

#### Запрос:
```json
{
  "palletId": 1,     // ID поддона (обязательное поле)
  "machineId": 2,    // ID станка (обязательное поле)
  "operatorId": 3,   // ID оператора, завершающего обработку (опционально)
  "segmentId": 4     // ID производственного участка (опционально)
}
```

#### Ответ в случае успеха (HTTP 200):
```json
{
  "operation": {
    "id": 42,
    "status": "COMPLETED",
    "completedAt": "2023-11-10T14:15:22Z",
    "isCompletedForDetail": true
    // и другие поля операции
  },
  "pallet": {
    "id": 1,
    "name": "Поддон-001",
    "currentStepId": 6,  // ID следующего этапа обработки (null если обработка полностью завершена)
    "detail": {
      // информация о детали
    },
    "currentStep": {
      // информация о следующем этапе (если есть)
    }
  },
  "nextStep": "Установлен следующий этап обработки"  // или "Обработка завершена" если это был последний этап
}
```

#### Возможные ошибки (HTTP 400):
- `"Поддон не найден"` - указан несуществующий ID поддона
- `"Станок не найден"` - указан несуществующий ID станка
- `"У поддона не указан текущий этап обработки. Невозможно завершить обработку"` - не задан текущий этап обработки для поддона
- `"Не найдена активная операция для поддона на станке с текущим этапом"` - система не может найти активную операцию с указанными параметрами
- `"Для завершения операции требуется указать оператора"` - не указан оператор при завершении и нет оператора в начале операции

### 3. Получить информацию о поддоне

**URL**: `/pallets/:id`  
**Метод**: GET  
**Описание**: Возвращает подробную информацию о поддоне

#### Параметры пути:
- `id` - ID поддона (число)

#### Ответ в случае успеха (HTTP 200):
```json
{
  "id": 1,
  "name": "Поддон-001",
  "quantity": 50,
  "detail": {
    "id": 10,
    "article": "АРТ-123",
    "name": "Деталь XYZ",
    "material": "ДСП",
    "size": "1200x600"
    // и другие поля детали
  },
  "currentStep": {
    "id": 5,
    "name": "Распил",
    "sequence": 1
    // и другие поля текущего этапа
  },
  "detailOperations": [
    // до 5 последних операций для данного поддона,
    // отсортированных по дате начала (сначала новые)
    {
      "id": 42,
      "status": "COMPLETED",
      "startedAt": "2023-11-10T12:34:56Z",
      "completedAt": "2023-11-10T14:15:22Z",
      "processStep": { /* инфо о шаге */ },
      "machine": { /* инфо о станке */ },
      "operator": { /* инфо об операторе */ },
      "master": { /* инфо о мастере (если участвовал) */ }
    },
    // ...другие операции
  ],
  "bufferCell": {
    // информация о ячейке буфера, если поддон размещен в буфере
    "id": 15,
    "code": "B3",
    "buffer": {
      "id": 3,
      "name": "Основной буфер"
      // и другие поля буфера
    }
  }
}
```

#### Возможные ошибки:
- HTTP 404 - `"Поддон не найден"`

### 4. Получить список поддонов для станка

**URL**: `/pallets/for-machine/:machineId`  
**Метод**: GET  
**Описание**: Возвращает список поддонов, готовых к обработке на указанном станке

#### Параметры пути:
- `machineId` - ID станка (число)

#### Ответ в случае успеха (HTTP 200):
```json
[
  {
    "id": 1,
    "name": "Поддон-001",
    "quantity": 50,
    "detail": {
      "id": 10,
      "article": "АРТ-123",
      "name": "Деталь XYZ"
      // и другие поля детали
    },
    "currentStep": {
      "id": 5, 
      "name": "Распил"
      // и другие поля текущего этапа обработки
    },
    "bufferCell": {
      // информация о ячейке буфера, если поддон размещен в буфере
    }
  },
  // ...другие поддоны
]
```

#### Возможные ошибки (HTTP 400):
- `"Станок не найден"` - указан несуществующий ID станка

## Примеры использования

### 1. Начало обработки поддона:

```http
POST /pallets/start-processing
Content-Type: application/json

{
  "palletId": 1,
  "machineId": 2,
  "operatorId": 3
}
```

### 2. Завершение обработки поддона:

```http
POST /pallets/complete-processing
Content-Type: application/json

{
  "palletId": 1,
  "machineId": 2,
  "operatorId": 3,
  "segmentId": 4
}
```

### 3. Получение информации о поддоне:

```http
GET /pallets/1
```

### 4. Получение списка поддонов для станка:

```http
GET /pallets/for-machine/2
```
